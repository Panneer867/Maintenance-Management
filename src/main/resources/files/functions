-- ------------------------------------
-- Function of STOCKSLASTTHREEMONTHS --
---------------------------------------

CREATE OR REPLACE FUNCTION stockslastthreemonths RETURN SYS_REFCURSOR IS
  stock_data SYS_REFCURSOR;
BEGIN
  OPEN stock_data FOR
   SELECT 'SPARES' AS type, TO_CHAR(date_created, 'MON') AS month_name, EXTRACT(MONTH FROM date_created) AS month_number, EXTRACT(YEAR FROM date_created) AS year, SUM(quantity) AS total_quantity
FROM MM_INWARD_APPROVED_SPARES
WHERE date_created >= SYSDATE - INTERVAL '3' MONTH
GROUP BY EXTRACT(YEAR FROM date_created), EXTRACT(MONTH FROM date_created), TO_CHAR(date_created, 'MON')

UNION

SELECT 'MATERIALS' AS type, TO_CHAR(date_created, 'MON') AS month_name, EXTRACT(MONTH FROM date_created) AS month_number, EXTRACT(YEAR FROM date_created) AS year, SUM(quantity) AS total_quantity
FROM MM_INWARD_APPROVED_MATERIALS
WHERE date_created >= SYSDATE - INTERVAL '3' MONTH
GROUP BY EXTRACT(YEAR FROM date_created), EXTRACT(MONTH FROM date_created), TO_CHAR(date_created, 'MON')

UNION

SELECT 'TOOLS' AS type, TO_CHAR(date_created, 'MON') AS month_name, EXTRACT(MONTH FROM date_created) AS month_number, EXTRACT(YEAR FROM date_created) AS year, SUM(quantity) AS total_quantity
FROM MM_INWARD_APPROVED_TOOLS
WHERE date_created >= SYSDATE - INTERVAL '3' MONTH
GROUP BY EXTRACT(YEAR FROM date_created), EXTRACT(MONTH FROM date_created), TO_CHAR(date_created, 'MON')

ORDER BY year ASC, month_number ASC, type ASC;

  RETURN stock_data;
END;